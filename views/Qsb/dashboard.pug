<!doctype html>
html(lang="es")
  head
    
    meta(charset="utf-8")
    meta(name="viewport" content="width=device-width, initial-scale=1")
    
    link(href="https://unpkg.com/ionicons@4.5.10-0/dist/css/ionicons.min.css" rel="stylesheet")
    link(href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet")
    link(rel="stylesheet", href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap5.min.css")
    link(rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css")
    link(rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css")
    <link href="//cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    title Polimetal S.A
    link(rel="stylesheet" href="/stylesheets/styleIndex.css")
  body
   
    
        
        
    
    <nav class="navbar navbar-light bg-light">
        <div class="container-fluid">
            button#menu-toggle.btn.btn-outline-primary ☰
            h3(class="navbar-brand") Dashboard

        </div>
    </nav>
    
    <div class="carousel-item active">
        <div class="container">
            <div class="row">
                <div class="col-md-2"><p>Sector</p></div>
                <div class="col-md-2"><p>Accidentes</p></div>
                <div class="col-md-2"><p>Scrap</p></div>
                <div class="col-md-2"><p>Cump Programa</p></div>
                <div class="col-md-2"><p>Disponibilidad</p></div>
                <div class="col-md-2"><p>Disp Molde/Retrabajo</p></div>
            </div>

            <div class="row">
                <div class="col-md-2"><p>INYECCION</p></div>
                <div class="col-md-2">
                    <div style="width: 100%; height: 100%;">
                        <canvas id="myChart"></canvas>
                    </div>
                </div>
                <div class="col-md-2">
                    <div style="width: 100%; height: 100%;">
                        <canvas id="myChart2"></canvas>
                    </div>
                </div>
                <div class="col-md-2">
                    <div style="width: 100%; height: 100%;">
                        <canvas id="myChart3"></canvas>
                    </div>
                </div>
                <div class="col-md-2">
                    <div style="width: 100%; height: 100%;">
                        <canvas id="myChart4"></canvas>
                    </div>
                </div>
                <div class="col-md-2">
                    <div style="width: 100%; height: 100%;">
                        <canvas id="myChart5"></canvas>
                    </div>
                </div>
                
            </div>

            <div class="row">
                <div class="col-md-2"><p>TT&CC</p></div>
                <div class="col-md-2">
                    <div style="width: 100%; height: 100%;">
                        <canvas id="myChart6"></canvas>
                    </div>
                </div>
                
            </div>

            <div class="row">
                <div class="col-md-2"><p>MECANIZADO</p></div>
                <div class="col-md-2">
                    <div style="width: 100%; height: 100%;">
                        <canvas id="myChart7"></canvas>
                    </div>
                </div>
              
            </div>
        </div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#sectorCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#sectorCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
    </button>                    
                   
    script(src="https://code.jquery.com/jquery-3.5.1.js")
    
    script(src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js")
    script(src="https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap5.min.js")   
    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous")

    script(src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous")
    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous")
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js" integrity="sha512-JPcRR8yFa8mmCsfrw4TNte1ZvF1e3+1SdGMslZvmrzDYxS69J7J49vkFL8u6u8PlPJK+H3voElBtUCzaXj+6ig==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    script.
        document.addEventListener("DOMContentLoaded", function() {
            const menuToggle = document.getElementById('menu-toggle');
            const sidebarContainer = document.getElementById('sidebar-container');

            menuToggle.addEventListener('click', function() {
                sidebarContainer.classList.toggle('active');
            });
        });
        
        $(document).ready(function () {
                        
                            
                                                     
                            
                    });
        document.addEventListener('DOMContentLoaded',function(){
            //Inyeccion
            initChart();
            initChart2();
            initChart3();
            initChart4();
            initChart5();
            //TTCC
            initChart6();
            initChart7();
            initChart8();
            

            
            var tabla2 = $('#table2').DataTable();
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1; 
            const currentYear = currentDate.getFullYear();
            document.getElementById('mes').value = currentMonth;
            document.getElementById('year').value = currentYear;
            updateChart(currentMonth, currentYear,"Inyeccion");

            let cons = document.getElementById('consultar');
            cons.addEventListener('click', (e) => {
            e.preventDefault();
            
            updateChart();
            });
            function initChart() {
                // Crea el gráfico en la carga de la página
                let ctx = document.getElementById('myChart').getContext("2d");
                let chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31],
                        datasets: [{
                            label: 'Accidentes',
                            data: [], // Los datos se actualizarán más tarde
                            borderWidth: 1
                        },
                        {
                            type: 'line',
                            
                            data: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            borderWidth: 1,
                            pointRadius:0,
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        plugins:{
                            legend:{
                                display:false,
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max:3,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    },
                    
                });

                return chart;
            }
            function initChart2() {
                // Crea el gráfico en la carga de la página
                let ctx = document.getElementById('myChart2').getContext("2d");
                let chart2 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31],
                        datasets: [{
                            label: 'Scrap',
                            data: [], // Los datos se actualizarán más tarde
                            borderWidth: 1
                        },
                        {
                            type: 'line',
                            
                            data: [6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5],
                            borderWidth: 1,
                            pointRadius:0,
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        plugins:{
                            legend:{
                                display:false,
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max:11,
                                min:2,
                                ticks: {
                                    stepSize: 0.5
                                }
                                
                            },
                            x:{
                            beginAtZero: true,
                            stacked:true
                            }
                        }
                    },
                    
                });

                return chart2;
            }
            function initChart3() {
                // Crea el gráfico en la carga de la página
                let ctx = document.getElementById('myChart3').getContext("2d");
                let chart3 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31],
                        datasets: [{
                            label: 'Cumplimiento de Programa',
                            data: [], // Los datos se actualizarán más tarde
                            borderWidth: 1
                        },
                        {
                            type: 'line',
                            
                            data: [100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],
                            borderWidth: 1,
                            pointRadius:0,
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        plugins:{
                            legend:{
                                display:false,
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                
                                
                            },
                            x:{
                            beginAtZero: true,
                            stacked:true
                            }
                        }
                    },
                    
                });

                return chart3;
            }
            function initChart4() {
                // Crea el gráfico en la carga de la página
                let ctx = document.getElementById('myChart4').getContext("2d");
                let chart4 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31],
                        datasets: [{
                            label: 'Disponibilidad MTTO',
                            data: [], // Los datos se actualizarán más tarde
                            borderWidth: 1,
                            
                        },
                        {
                            type: 'line',
                            
                            data: [96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96],
                            borderWidth: 1,
                            pointRadius:0,
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        plugins:{
                            legend:{
                                display:false,
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                min:60,
                                max:100,
                                ticks: {
                                    stepSize: 2,
                                }
                                
                            },
                            x:{
                            beginAtZero: true,
                            stacked:true
                            }
                        }
                    },
                    
                });

                return chart4;
            }
            function initChart5() {
                // Crea el gráfico en la carga de la página
                let ctx = document.getElementById('myChart5').getContext("2d");
                let chart5 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31],
                        datasets: [{
                            label: 'Disponibilidad Moldes',
                            data: [], // Los datos se actualizarán más tarde
                            borderWidth: 1
                        },
                        {
                            type: 'line',
                            
                            data: [99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],
                            borderWidth: 1,
                            pointRadius:0,
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        plugins:{
                            legend:{
                                display:false,
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                min:80,
                                max:100,
                                ticks: {
                                    stepSize: 1,
                                }
                                
                            },
                            x:{
                            beginAtZero: true,
                            stacked:true
                            }
                        }
                    },
                    
                });

                return chart5;
            }
            //TTCC
            function initChart6() {
                // Crea el gráfico en la carga de la página
                let ctx = document.getElementById('myChart6').getContext("2d");
                let chart6 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31],
                        datasets: [{
                            label: 'Accidentes',
                            data: [], // Los datos se actualizarán más tarde
                            borderWidth: 1
                        },
                        {
                            type: 'line',
                            label: 'Objetivo',
                            data: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            borderWidth: 1,
                            borderRadius:0,
                            pointRadius:0,
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        plugins:{
                            legend:{
                                display:false,
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                
                                max:3,
                                ticks: {
                                    stepSize: 1,
                                }
                            }
                        },
                    },
                    
                });

                return chart6;
            }
            function initChart7() {
                // Crea el gráfico en la carga de la página
                let ctx = document.getElementById('myChart7').getContext("2d");
                let chart7 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31],
                        datasets: [{
                            label: 'Scrap',
                            data: [], // Los datos se actualizarán más tarde
                            borderWidth: 1
                        },
                        {
                            type: 'line',
                            label: 'Objetivo',
                            data: [6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5,6.5],
                            borderWidth: 1,
                            pointRadius:0,
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        plugins:{
                            legend:{
                                display:false,
                            }
                            
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                
                            },
                            x:{
                            beginAtZero: true,
                            stacked:true
                            }
                        }
                    },
                    
                });

                return chart7;
            }
            function initChart8() {
                // Crea el gráfico en la carga de la página
                let ctx = document.getElementById('myChart8').getContext("2d");
                let chart8 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31],
                        datasets: [{
                            label: 'Disponibilidad MTTO',
                            data: [], // Los datos se actualizarán más tarde
                            borderWidth: 1
                        },
                        {
                            type: 'line',
                            label: 'Objetivo',
                            data: [96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96],
                            borderWidth: 1,
                            pointRadius:0,
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        plugins:{
                            legend:{
                                display:false,
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                
                            },
                            x:{
                            beginAtZero: true,
                            stacked:true
                            }
                        }
                    },
                    
                });

                return chart8;
            }
            

            
            
        })
        
        function updateChart(mes,year,sector){

                function fecha(x){
                    let f = new Date(x);
                    let dia=f.getDate();
                    let mes = f.getMonth()+1;
                    let año = f.getUTCFullYear();
                    let fecha = dia+"/"+mes+"/"+año;
                    return fecha
                }
                
                
                
                var mes = document.getElementById('mes').value;
                var year = document.getElementById('year').value;
                var sector = document.getElementById('sector').value;

                
                fetch(`/Qsb/datos?sector=${sector}&mes=${mes}&year=${year}`)
                    .then(response => response.json())
                    .then(datos =>{
                        

                        let chart = Chart.instances[0];
                        chart.data = {
                                labels: datos.map(e => fecha(e.fecha)),
                                
                                datasets: [{
                                    data: datos.map(e => e.accidentes),
                                    label:'Accidentes',
                                    type:'line',
                                    lineTension: 0,
                                    backgroundColor: 'transparent',
                                    borderColor: '#007bff',
                                    borderWidth: 4,
                                    pointBackgroundColor: '#007bff',
                                    datalabels:{
                                        align:'top',
                                        font:{
                                            weight:'bold'
                                        },
                                    }
                                },
                                {
                                    data: datos.map(e => 0),
                                    
                                    type:'line',
                                    lineTension: 0,
                                    backgroundColor: 'transparent',
                                    borderColor: '#990606',
                                    borderWidth: 4,
                                    pointRadius:0,
                                    pointBackgroundColor: '#007bff',
                                    datalabels:{
                                    display:false
                                    }
                                }],
                                
                                
                            }
                        chart.update();

                        let chart2 = Chart.instances[1];
                            chart2.data = {
                                labels: datos.map(e => fecha(e.fecha)),
                                
                                datasets: [{
                                    data: datos.map(e => e.scrap),
                                    label:'Scrap',
                                    type:'line',
                                    lineTension: 0,
                                    backgroundColor: '#007bff',
                                    borderColor: '#007bff',
                                    borderWidth: 1,
                                    borderRadius:5,
                                    pointBackgroundColor: '#007bff',
                                    datalabels:{
                                    offset:'top',
                                    anchor:'end',
                                    font:{
                                        weight:'bold',
                                        
                                    }
                                    }
                                
                                },
                            
                                {
                                    data: datos.map(e => 4.5),
                                    
                                    type:'line',
                                    lineTension: 0,
                                    backgroundColor: 'transparent',
                                    borderColor: '#990606',
                                    borderWidth: 2,
                                    pointRadius:0,
                                    pointBackgroundColor: '#007bff',
                                    datalabels:{
                                    display:false
                                    }
                                }],
                                
                                
                                }  
                        chart2.update(); 

                        let chart3 = Chart.instances[2];
                            chart3.data = {
                                labels: datos.map(e => fecha(e.fecha)),
                                
                                datasets: [{
                                    data: datos.map(e => e.c_programa),
                                    label:'Cumplimiento de Programa',
                                    type:'line',
                                    lineTension: 0,
                                    backgroundColor: '#007bff',
                                    borderColor: '#007bff',
                                    borderWidth: 1,
                                    borderRadius:5,
                                    pointBackgroundColor: '#007bff',
                                    datalabels:{
                                    offset:'top',
                                    anchor:'end',
                                    font:{
                                        weight:'bold',
                                        
                                    }
                                    }
                                
                                },
                            
                                {
                                    data: datos.map(e => 100),
                                   
                                    type:'line',
                                    lineTension: 0,
                                    backgroundColor: 'transparent',
                                    borderColor: '#990606',
                                    borderWidth: 2,
                                    pointRadius:0,
                                    
                                    pointBackgroundColor: '#007bff',
                                    datalabels:{
                                    display:false
                                    }
                                }],
                                
                                
                                } 
                        chart3.update();  

                        let chart4 = Chart.instances[3];
                            chart4.data = {
                                labels: datos.map(e => fecha(e.fecha)),
                                
                                datasets: [{
                                    data: datos.map(e => e.disponibilidad),
                                    label:'Disponibilidad MTTO',
                                    type:'line',
                                    lineTension: 0,
                                    backgroundColor: '#007bff',
                                    borderColor: '#007bff',
                                    borderWidth: 1,
                                    borderRadius:5,
                                    pointBackgroundColor: '#007bff',
                                    datalabels:{
                                    offset:'top',
                                    anchor:'end',
                                    font:{
                                        weight:'bold',
                                        
                                    }
                                    }
                                
                                },
                            
                                {
                                    data: datos.map(e => 96),
                                    
                                    type:'line',
                                    lineTension: 0,
                                    backgroundColor: 'transparent',
                                    borderColor: '#990606',
                                    borderWidth: 2,
                                    pointRadius:0,
                                    pointBackgroundColor: '#007bff',
                                    datalabels:{
                                    display:false
                                    }
                                }],
                                
                                
                                } 
                        chart4.update();  

                        let chart5 = Chart.instances[4];
                            chart5.data = {
                                labels: datos.map(e => fecha(e.fecha)),
                                
                                datasets: [{
                                    data: datos.map(e => e.disp_molde),
                                    label:'Disponibilidad Moldes',
                                    type:'line',
                                    lineTension: 0,
                                    backgroundColor: '#007bff',
                                    borderColor: '#007bff',
                                    borderWidth: 1,
                                    borderRadius:5,
                                    pointBackgroundColor: '#007bff',
                                    datalabels:{
                                    offset:'top',
                                    anchor:'end',
                                    font:{
                                        weight:'bold',
                                        
                                    }
                                    }
                                
                                },
                            
                                {
                                    data: datos.map(e => 99),
                                    
                                    type:'line',
                                    lineTension: 0,
                                    backgroundColor: 'transparent',
                                    borderColor: '#990606',
                                    borderWidth: 2,
                                    pointRadius:0,
                                    pointBackgroundColor: '#007bff',
                                    datalabels:{
                                    display:false
                                    }
                                }],
                                
                                
                                } 
                        chart5.update();
                        const indicadores = datos.map(e => {
                                    const hsreal = e.hsReal;
                                    const hs_rd = e.hs_rd;
                                    const rds_real = e.rds_real;
                                    const rds_teoricas = hsreal / hs_rd;
                                    const indicador = rds_real / rds_teoricas;
                                    const ind = 0.9 / indicador;
                                    return parseFloat(ind.toFixed(3));;
                                });
                        let chart6 = Chart.instances[5];
                            chart6.data = {
                                labels: datos.map(e => fecha(e.fecha)),
                                
                                datasets: [{
                                    data: indicadores,
                                    label:'Seguimiento de mano de obra',
                                    type:'line',
                                    lineTension: 0,
                                    backgroundColor: '#007bff',
                                    borderColor: '#007bff',
                                    borderWidth: 1,
                                    borderRadius:5,
                                    pointBackgroundColor: '#007bff',
                                    datalabels:{
                                    offset:'top',
                                    anchor:'end',
                                    font:{
                                        weight:'bold',
                                        
                                    }
                                    }
                                
                                },
                            
                                {
                                    data: datos.map(e => 0.9),
                                    
                                    type:'line',
                                    lineTension: 0,
                                    backgroundColor: 'transparent',
                                    borderColor: '#990606',
                                    borderWidth: 2,
                                    pointRadius:0,
                                    pointBackgroundColor: '#007bff',
                                    datalabels:{
                                    display:false
                                    }
                                }],
                                option
                                
                                
                                } 
                        chart6.update();

                        $('#table2').DataTable().destroy();
                        let dataset=[];
                            for(let i=0;i<datos.length;i++){
                                if(datos[i].observaciones){
                                    var dat=[
                                datos[i].id,
                                fecha(datos[i].fecha),
                                datos[i].observaciones,
                                '<a href="editarIndicador?id=' + datos[i].id + '" class="btn btn-primary btn-edit">Editar</a>'
                                
                                ]
                                dataset.push(dat);
                                }
                            
                            }
                        $('#table2').DataTable({
                            
                            dom: 'Bfrtlip',
                            paging:false,
                            data:dataset,
                            columns:[
                                {title:'id'},
                                {title:'Fecha'},
                                {title:'Observaciones'},
                                {title:'Accion'},
                            ],
                    }); 

                     
                    })
            }  

